<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" href="{{ site.baseurl }}/css/style.css" type="text/css" />
</head>

<!-- class hyphenate to let Hyphenator hyphenate.. -->

<body class="rpg-layout">
  <header class="site-header">
    <nav class="nav-container">
      <div class="logo">The Setting Name</div>
      <ul class="nav-links">
        <li><a href="{{ site.baseurl }}/index.html">Home</a></li>
        <li><a href="{{ site.baseurl }}/posts/">All Posts</a></li>
        <li><a href="{{ site.baseurl }}/categories/">All Categories</a></li>
      </ul>
    </nav>
  </header>

  <div id="page-container">

    <aside id="sidebar">
      <h1>Recent Posts</h1>
      <ul>
        {% for post in site.posts limit:5 %}
        <li><a href="{{ site.baseurl }}{{ post.url }}">{{ post.title }}</a></li>
        {% endfor %}
      </ul>
    </aside>

    <main>
      <h1>{{ page.title }}</h1>
      {{ content }}

      

{% if page.collection == 'posts' %}
<div id="comment-section" style="margin-top: 50px; border-top: 1px solid #ccc; padding-top: 20px;">
  <h3>Comments</h3>
  <div id="comments-display" style="margin-bottom: 30px;">Loading comments...</div>

  <hr>
  <h3>Leave a Comment</h3>
  <form id="comment-form">
    <div style="display:none;">
      <label>Do not fill this field if you are human:</label>
      <input type="text" id="honeypot" name="website" tabindex="-1" autocomplete="off">
    </div>
    <input type="hidden" id="page-url" value="{{ page.url }}">
    <input type="text" id="user-name" placeholder="Your Name" required style="width: 100%; margin-bottom: 10px;"><br>
    <textarea id="user-comment" placeholder="Your Comment" required style="width: 100%; height: 100px; margin-bottom: 10px;"></textarea><br>
    <button id="submit-btn" type="submit">Submit Comment</button>
  </form>
  <div id="response-msg"></div>
</div>

<script>
  const scriptUrl = 'https://script.google.com/macros/s/AKfycbz4Fijnf_iStHEO1tuWmj_RkIaF-3YfoqBuFYQctfa-Rb1EwgAprRN2rxf3bg3mRoFqJg/exec';
  const currentPage = document.getElementById('page-url').value;
  const loadTime = Date.now(); // Record when the page loaded

  async function loadComments() {
    try {
      const response = await fetch(`${scriptUrl}?page=${encodeURIComponent(currentPage)}`);
      const filteredComments = await response.json();
      const displayArea = document.getElementById('comments-display');
      
      if (filteredComments.length === 0) {
        displayArea.innerHTML = '<p>No comments for this entry yet.</p>';
        return;
      }

      displayArea.innerHTML = filteredComments.map(c => `
        <div style="margin-bottom: 15px; padding: 10px; border-bottom: 1px solid #333;">
          <strong style="color: #d4af37;">${c.name}</strong> 
          <span style="font-size: 0.8em; opacity: 0.5;">• ${new Date(c.timestamp).toLocaleDateString()}</span>
          <p style="margin: 5px 0 0 0;">${c.comment}</p>
        </div>
      `).join('');
    } catch (err) {
      document.getElementById('comments-display').innerHTML = '<p>Could not load comments.</p>';
    }
  }

  document.getElementById('comment-form').addEventListener('submit', function(e) {
    e.preventDefault();

    // 1. Honeypot check: If filled, it's a bot
    if (document.getElementById('honeypot').value !== "") {
      console.warn("Honeypot filled. Submission ignored.");
      return;
    }
    
    const data = {
      page: currentPage,
      name: document.getElementById('user-name').value,
      comment: document.getElementById('user-comment').value
    };

    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerText = "Sending...";

    fetch(scriptUrl, {
      method: 'POST',
      mode: 'no-cors',
      body: JSON.stringify(data)
    }).then(() => {
      document.getElementById('response-msg').innerText = "Sent! Refresh the page to see your comment.";
      document.getElementById('comment-form').reset();
      btn.innerText = "Post Comment";
      btn.disabled = false;
      setTimeout(loadComments, 1500);
    });
  });

  loadComments();
</script>
{% endif %}

    </main>

  </div>

  <footer class="site-footer">
    <p>© 2026 fantomx11</p>
  </footer>
</body>

</html>
